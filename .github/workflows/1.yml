name: Keep Servers Alive
on:
  schedule:
    - cron: '50 4 * * *'  # æ¯4å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:
env:
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  ACCOUNTS: ${{ secrets.ACCOUNTS }}

jobs:
  kee:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@main

      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass curl jq

      - name: Process each account
        run: |
          run_remote_command() {
            local RES=$1
            local SSH_USER=$2
            local SSH_PASS=$3
            local REALITY=${4}
            local SUUUID=$5
            local TCP1_PORT=$6
            local TCP2_PORT=$7
            local UDP_PORT=$8
            local HOST=$9
            local ARGO_DOMAIN=${10}
            local ARGO_AUTH=${11}
            if [ -z "${ARGO_DOMAIN}" ]; then
              echo "ArgoåŸŸåä¸ºç©ºï¼Œç”³è¯·Argoä¸´æ—¶åŸŸå"
            else
              echo "Argoå·²è®¾ç½®å›ºå®šåŸŸåï¼š${ARGO_DOMAIN}"
            fi
            remote_command="export reym=$REALITY UUID=$SUUID vless_port=$TCP1_PORT vmess_port=$TCP2_PORT hy2_port=$UDP_PORT reset=$RES ARGO_DOMAIN=${ARGO_DOMAIN} ARGO_AUTH=${ARGO_AUTH} && bash <(curl -Ls https://raw.githubusercontent.com/yonggekkk/sing-box-yg/main/serv00keep.sh)"
            echo "Executing remote command on $HOST as $SSH_USER"
            sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no "$SSH_USER@$HOST" "$remote_command" > /dev/null 2>&1
          }

          send_telegram_notification() {
          local message=$1
            # åŠ å…¥ spoiler æ•ˆæœ
            # è½¬ä¹‰ MarkdownV2 ä¸­çš„ç‰¹æ®Šå­—ç¬¦ï¼Œç‰¹åˆ«æ˜¯ '!' å­—ç¬¦
             local escaped_message=$(echo "$message" | sed 's/[][(){}._*+^$|\\?-]/\\&/g' | sed 's/!/\\!/g')
    
           # ä½¿ç”¨ MarkdownV2 æ·»åŠ  spoiler æ•ˆæœ
             local spoiler_message="||$escaped_message||"
    
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$spoiler_message" \
            -d parse_mode="MarkdownV2" /dev/null 2>&1
           }


          echo "*****************************************************"
          echo "*****************************************************"
          echo "ç”¬å“¥Githubé¡¹ç›® ï¼šgithub.com/yonggekkk"
          echo "ç”¬å“¥Bloggeråšå®¢ ï¼šygkkk.blogspot.com"
          echo "ç”¬å“¥YouTubeé¢‘é“ ï¼šwww.youtube.com/@ygkkk"
          echo "è‡ªåŠ¨è¿œç¨‹éƒ¨ç½²å¹¶ä¿æ´»Serv00ä¸‰åˆä¸€åè®®è„šæœ¬ã€Githubã€‘"
          echo "ç‰ˆæœ¬ï¼šV25.1.22"
          echo "*****************************************************"
          echo "*****************************************************"

          count=0
          for account in $(echo "${ACCOUNTS}" | jq -c '.[]'); do
            count=$((count+1))
            RES=$(echo $account | jq -r '.RES')
            SSH_USER=$(echo $account | jq -r '.SSH_USER')
            SSH_PASS=$(echo $account | jq -r '.SSH_PASS')
            REALITY=$(echo $account | jq -r '.REALITY')
            SUUUID=$(echo $account | jq -r '.SUUID')
            TCP1_PORT=$(echo $account | jq -r '.TCP1_PORT')
            TCP2_PORT=$(echo $account | jq -r '.TCP2_PORT')
            UDP_PORT=$(echo $account | jq -r '.UDP_PORT')
            HOST=$(echo $account | jq -r '.HOST')
            ARGO_DOMAIN=$(echo $account | jq -r '.ARGO_DOMAIN')
            ARGO_AUTH=$(echo $account | jq -r '.ARGO_AUTH')

            if sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no "$SSH_USER@$HOST" -q exit; then
              echo "ğŸ‰æ­å–œï¼âœ…ç¬¬ã€$countã€‘å°æœåŠ¡å™¨è¿æ¥æˆåŠŸï¼ğŸš€æœåŠ¡å™¨åœ°å€ï¼š$HOST ï¼Œè´¦æˆ·"
              if [ -z "${ARGO_DOMAIN}" ]; then
                check_process="ps aux | grep '[c]onfig' > /dev/null && ps aux | grep [l]ocalhost:$TCP2_PORT > /dev/null"
              else
                check_process="ps aux | grep '[c]onfig' > /dev/null && ps aux | grep '[t]oken $ARGO_AUTH' > /dev/null"
              fi

              if ! sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no "$SSH_USER@$HOST" "$check_process" || [[ "$RES" =~ ^[Yy]$ ]]; then
                echo "âš ï¸æ£€æµ‹åˆ°ä¸»è¿›ç¨‹æˆ–è€…argoè¿›ç¨‹æœªå¯åŠ¨ï¼Œæˆ–è€…æ‰§è¡Œé‡ç½®"
                send_telegram_notification "âš ï¸æ£€æµ‹åˆ°ä¸»è¿›ç¨‹æˆ–è€…argoè¿›ç¨‹æœªå¯åŠ¨ï¼Œæˆ–è€…æ‰§è¡Œé‡ç½®ğŸš€æœåŠ¡å™¨åœ°å€ï¼š$HOST ||éœ€è¦é‡ç½®çš„è¯¦ç»†ä¿¡æ¯||"
                output=$(run_remote_command "$RES" "$SSH_USER" "$SSH_PASS" "${REALITY}" "$SUUID" "$TCP1_PORT" "$TCP2_PORT" "$UDP_PORT" "$HOST" "${ARGO_DOMAIN}" "${ARGO_AUTH}")
                echo "è¿œç¨‹å‘½ä»¤æ‰§è¡Œç»“æœå·²æˆåŠŸéšè—ã€‚"
              else
                echo "ğŸ‰æ­å–œï¼âœ…æ£€æµ‹åˆ°æ‰€æœ‰è¿›ç¨‹æ­£å¸¸è¿è¡Œä¸­ "
                send_telegram_notification "ğŸ‰æ­å–œï¼âœ…æ£€æµ‹åˆ°æ‰€æœ‰è¿›ç¨‹æ­£å¸¸è¿è¡Œä¸­ï¼ğŸš€æœåŠ¡å™¨åœ°å€:$HOST"
              fi
            else
              echo "===================================================="
              echo "ğŸ’¥æ¯å…·ï¼âŒç¬¬ã€$countã€‘å°æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼ğŸš€æœåŠ¡å™¨åœ°å€ï¼š$HOST ï¼Œè´¦æˆ·åï¼š$SSH_USER"
              send_telegram_notification "ğŸ’¥æ¯å…·ï¼âŒç¬¬ã€$countã€‘å°æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼ğŸš€æœåŠ¡å™¨åœ°å€ï¼š$HOST ï¼Œè´¦æˆ·åï¼š$SSH_USER ||é”™è¯¯çš„è´¦æˆ·æˆ–æœåŠ¡å™¨æ•…éšœ||"
              echo "===================================================="
            fi
          done

      - name: Delete Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2.0.6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 1
          keep_minimum_runs: 0
