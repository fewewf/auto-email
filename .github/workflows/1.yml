name: Keep Servers Alive
on:
  schedule:
    - cron: '40 5 * * 6'  # æ¯å¤©5:40æ‰§è¡Œ
  workflow_dispatch:
env:
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  ACCOUNTS: ${{ secrets.ACCOUNTS }}

jobs:
  kee:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@main

      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass curl jq

      - name: Process each account
        run: |
          send_telegram_notification() {
            local message=$1
            # è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
            local escaped_message=$(echo "$message" | sed 's/[][(){}._*+^$|\\?-]/\\&/g' | sed 's/!/\\!/g')
            # ä½¿ç”¨ MarkdownV2
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
              -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
              -d text="$escaped_message" \
              -d parse_mode="MarkdownV2" > /dev/null 2>&1
          }

          
          count=0
          for account in $(echo "${ACCOUNTS}" | jq -c '.[]'); do
            count=$((count+1))
            SSH_USER=$(echo $account | jq -r '.SSH_USER')
            SSH_PASS=$(echo $account | jq -r '.SSH_PASS')
            HOST=$(echo $account | jq -r '.HOST')

            # æµ‹è¯•SSHè¿æ¥ï¼Œä½¿ç”¨-tå¼ºåˆ¶åˆ†é…ä¼ªç»ˆç«¯
            if sshpass -p "$SSH_PASS" ssh -t -o StrictHostKeyChecking=no "$SSH_USER@$HOST" "exit"; then
              echo "ğŸ‰ ç¬¬ã€$countã€‘å°æœåŠ¡å™¨è¿æ¥æˆåŠŸï¼åœ°å€ï¼š$HOST"
              send_telegram_notification "âœ… æœåŠ¡å™¨è¿æ¥æˆåŠŸï¼åœ°å€: $HOST"
            else
              echo "âŒ ç¬¬ã€$countã€‘å°æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼åœ°å€ï¼š$HOST"
              send_telegram_notification "âœ… æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼åœ°å€: $HOST"
            fi
          done

